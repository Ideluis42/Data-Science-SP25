---
title: "Challenge 13: NYC Taxi Data"
author: "Isa de Luis & Sam Mendelson"
date: 2025-04-28
output: 
  github_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
if (!require(arrow)) install.packages("arrow")

library(tidyverse)
library(arrow)
library(ggplot2)
library(tidyr)
library(dplyr)
library(sf)

```

# Overview

This dataset, [from the NYC Taxi and Limousine Commission](https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page), contains information about taxi trips in New York City.

New York City enacted a **congestion pricing** scheme in January 2025, which charges a fee for all vehicles entering Manhattan below 60th Street. While personal vehicles can get charged up to \$9/day (charged at first entry during a specified calendar day), congestion pricing for taxis works differently: they pay \$0.75/entry, which is then passed on to the passenger.

## Columns

| Field Name | Category | Description |
|---------------------------------|---------------------|------------------|
| `VendorID` | Vendor Info | A code indicating the TPEP provider that provided the record. 1 = Creative Mobile Technologies, LLC 2 = Curb Mobility, LLC 6 = Myle Technologies Inc 7 = Helix |
| `tpep_pickup_datetime` | Time | The date and time when the meter was engaged. |
| `tpep_dropoff_datetime` | Time | The date and time when the meter was disengaged. |
| `passenger_count` | Passenger Info | The number of passengers in the vehicle. |
| `trip_distance` | Trip Info | The elapsed trip distance in miles reported by the taximeter. |
| `RatecodeID` | Fare Info | The final rate code in effect at the end of the trip. 1 = Standard rate 2 = JFK 3 = Newark 4 = Nassau or Westchester 5 = Negotiated fare 6 = Group ride 99 = Null/unknown |
| `store_and_fwd_flag` | Trip Info | Flag indicating whether the trip record was stored before being sent to the vendor.<br>Y = store and forward trip<br>N = not a store and forward trip |
| `PULocationID` | Location | TLC Taxi Zone where the taximeter was engaged. |
| `DOLocationID` | Location | TLC Taxi Zone where the taximeter was disengaged. |
| `payment_type` | Payment Info | Numeric code indicating how the passenger paid. 0 = Flex Fare 1 = Credit card 2 = Cash 3 = No charge 4 = Dispute 5 = Unknown 6 = Voided trip |
| `fare_amount` | Fare Info | Time-and-distance fare calculated by the meter. [More info](https://www.nyc.gov/site/tlc/passengers/taxi-fare.page) |
| `extra` | Fare Info | Miscellaneous extras and surcharges. |
| `mta_tax` | Tax Info | Tax automatically triggered based on the metered rate. |
| `tip_amount` | Fare Info | Tip amount â€“ automatically populated for credit card trips. Cash tips are not included. |
| `tolls_amount` | Fare Info | Total amount of all tolls paid in trip. |
| `improvement_surcharge` | Fare Info | Improvement surcharge assessed at the flag drop since 2015. |
| `total_amount` | Fare Info | Total amount charged to passengers (excludes cash tips). |
| `congestion_surcharge` | Fare Info | Total amount collected for NYS congestion surcharge. |
| `airport_fee` | Fare Info | For pickups at LaGuardia and JFK airports only. |
| `cbd_congestion_fee` | Fare Info | Per-trip charge for MTA's Congestion Relief Zone (starting Jan. 5, 2025). |

## Congestion Pricing vs. Congestion Surcharge

You may have noticed that there are two different fees related to congestion in the dataset: `congestion_surcharge` and `cbd_congestion_fee`. The former is a fee that was introduced in 2019 to help fund the MTA, while the latter is a new fee that was introduced in 2025 as part of the congestion pricing scheme.

The politics of congestion pricing have been contentious in New York City for years. The plan was first proposed in 2007, but it wasn't until 2019 that the state legislature passed a bill allowing for congestion pricing. Tolls for private vehicles were sacked, however a $2.50 per ride fee for taxi and ride share trips that originate in, end in, or pass through Manhattan below 96th street was established, which is in our dataset as the `congestion_surcharge`.

In 2025, the congestion pricing scheme was fully implemented, which is in our dataset as `cbd_congestion_fee`. This fee is charged to all vehicles entering Manhattan below 60th Street, regardless of whether they are taxis or private vehicles. The goal of the fee is to reduce traffic congestion and improve air quality in Manhattan.

For taxi trips, these two fees can add together. For example, a trip going from 112th Street to 16th Street would pay both fees, as the trip:

- Begins above 96th street - no fee
- Ends below 96th street, therefore the `congestion_surcharge` is applied
- Needs to enter the congestion pricing zone (destination is below 60th street), therefore the `cbd_congestion_fee` is applied

This results in a total fee of $3.25 ($2.50 from the congestion surcharge and $0.75 from the congestion pricing scheme) applied to the trip.

Read more about the congestion _surcharge_ [here](https://www.tax.ny.gov/bus/cs/csidx.htm) and the congestion _pricing_ [here](https://portal.311.nyc.gov/article/?kanumber=KA-03612).

## TLC Taxi Zones

The dataset tells us, roughly, where the trips start and end. New York City is broken up into TLC taxi zones, and we have the pickup and dropoff zone IDs in the dataset. The TLC taxi zones are not the same as the NYC neighborhoods, but they are similar. For example, the Upper West Side is broken up into several different TLC taxi zones, while the East Village is only one zone.

The Metropolitan Transportation Authority (MTA, New York City's public transportation authority) released a complimentary dataset that lists the zones 

# Central Claim



# EDA

```{r}
df_feb_25_green <- read_parquet("data/project/green_tripdata_2025-02.parquet")
df_feb_25_yellow <- read_parquet("data/project/yellow_tripdata_2025-02.parquet")

df_feb_24_green <- read_parquet("data/project/green_tripdata_2024-02.parquet")
df_feb_24_yellow <- read_parquet("data/project/yellow_tripdata_2024-02.parquet")
```

```{r}

df_feb_25_green <- 
  df_feb_25_green |>
  mutate(year = 2025,
         color = "green")

df_feb_24_green <- 
  df_feb_24_green |>
  mutate(year = 2024,
         color = "green")

df_feb_25_yellow <- 
  df_feb_25_yellow |>
  mutate(year = 2025,
         color = "yellow")

df_feb_24_yellow <- 
  df_feb_24_yellow |>
  mutate(year = 2024,
         color = "yellow")
df_combined <- bind_rows(df_feb_25_green, df_feb_25_yellow, df_feb_24_green, df_feb_24_yellow)
```

```{r}
glimpse(df_combined)
head(df_combined)
```


## Plots

```{r}
zone_lookup <- read_csv("data/project/taxi_zones.csv")
zone_lookup <- zone_lookup |>
  rename(LocationID = `Taxi Zone`)

zones_sf <- zone_lookup |>     
  st_as_sf(wkt = "Polygon", crs = 4326)        

df_zone_by_year <- df_combined |>
  group_by(year, DOLocationID) |>
  summarise(n_rides = n(), .groups = "drop")

df_zone_by_year <- df_zone_by_year |>
  group_by(year) |>
  mutate(
    frac  = n_rides / sum(n_rides),       
    pct   = frac * 100                    
  ) %>%
  ungroup()

map_data <- zones_sf |>
  left_join(df_zone_by_year,
            by = c("LocationID" = "DOLocationID"))

map_data |>
  ggplot() +
  geom_sf(aes(fill = pct), color = "grey70", size = 0.1) +
  scale_fill_viridis_c(
    option    = "magma",
    trans     = "sqrt",
    na.value  = "white"
  ) +
  facet_wrap(~ year) +
  labs(
    title    = "Feb Taxi Dropoffs in Manhattan by Zone",
    subtitle = "2024 vs 2025",
    fill     = "Number of Rides"
  ) +
  theme_minimal(base_size = 14) +
  theme(
    axis.text    = element_blank(),
    axis.ticks   = element_blank(),
    panel.grid   = element_blank(),
    strip.text   = element_text(face = "bold")
  ) 

```

```{r}
# Mean Fare, Mean distance, mean tip percent per pickup zone
df_zone_stats <- df_combined |>
  filter(fare_amount > 0) |>
  group_by(year, PULocationID)|>
  summarise(
    mean_fare    = mean(fare_amount,      na.rm = TRUE),
    mean_tip_pct = mean(tip_amount/fare_amount*100, na.rm = TRUE),
    mean_dist    = mean(trip_distance,    na.rm = TRUE),
    .groups = "drop"
  )

zone_stats_sf <- zones_sf %>%
  left_join(df_zone_stats, by = c("LocationID" = "PULocationID"))

plot_map <- function(col, legend.title) {
  zone_stats_sf |>
  ggplot() +
    geom_sf(aes_string(fill = col), color = "grey80", size = 0.1) +
    facet_wrap(~year) +
    scale_fill_viridis_c(
      option   = "plasma",
      trans    = "sqrt",
      na.value = "white"
    ) +
    labs(fill   = legend.title,
         title  = legend.title,
         subtitle = "Feb 2024 vs Feb 2025") +
    theme_minimal() +
    theme(
      axis.text  = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      strip.text = element_text(face = "bold")
    )
}

plot_map("mean_fare",    "Mean Fare ($)")
plot_map("mean_tip_pct", "Mean Tip (%)")
plot_map("mean_dist",    "Mean Distance (mi)")
```


```{r}
# Mean Fare, Mean distance, mean tip percent per dropoff zone
df_zone_stats <- df_combined |>
  filter(fare_amount > 0) |>
  group_by(year, DOLocationID)|>
  summarise(
    mean_fare    = mean(fare_amount,      na.rm = TRUE),
    mean_tip_pct = mean(tip_amount/fare_amount*100, na.rm = TRUE),
    mean_dist    = mean(trip_distance,    na.rm = TRUE),
    .groups = "drop"
  )

zone_stats_sf <- zones_sf %>%
  left_join(df_zone_stats, by = c("LocationID" = "DOLocationID"))

plot_map <- function(col, legend.title) {
  zone_stats_sf |>
  ggplot() +
    geom_sf(aes_string(fill = col), color = "grey80", size = 0.1) +
    facet_wrap(~year) +
    scale_fill_viridis_c(
      option   = "plasma",
      trans    = "sqrt",
      na.value = "white"
    ) +
    labs(fill   = legend.title,
         title  = legend.title,
         subtitle = "Feb 2024 vs Feb 2025") +
    theme_minimal() +
    theme(
      axis.text  = element_blank(),
      axis.ticks = element_blank(),
      panel.grid = element_blank(),
      strip.text = element_text(face = "bold")
    )
}

plot_map("mean_fare",    "Mean Fare ($)")
plot_map("mean_tip_pct", "Mean Tip (%)")
plot_map("mean_dist",    "Mean Distance (mi)")
```

